name: IOSFA Scraper

on:
  workflow_dispatch:
    inputs:
      start:
        description: 'Número inicial de usuario'
        required: true
        default: 21000
      end:
        description: 'Número final de usuario'
        required: true
        default: 21010
      release_name:
        description: 'Nombre del release'
        required: true
        default: 'Afiliados-IOSFA'

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Scrape data
        run: |
          START=${{ github.event.inputs.start }}
          END=${{ github.event.inputs.end }}
          OUTPUT="resultado.txt"
          > $OUTPUT

          for USER_ID in $(seq $START $END); do
            echo "Procesando USER $USER_ID"
            URL="http://validador.iosfa.gob.ar:5080/Afiliados/Titular/Editar/${USER_ID}"

            RESPONSE=$(curl -s -L "$URL" \
              -H "User-Agent: Mozilla/5.0" \
              -H "Accept: text/html")

            if [[ "$RESPONSE" != *"FUERZA DE ORIGEN"* ]]; then
              echo "USER $USER_ID = SIN DATOS" >> $OUTPUT
              continue
            fi

            extract() {
              echo "$RESPONSE" | grep -oP "$1" | head -n1 | sed 's/^[ \t]*//;s/[ \t]*$//'
            }

            TIPO=$(extract '(?<=cboTipoDocumentos_I\" type=\"text\" value=\").*?(?=\")')
            ESTADO=$(extract '(?<=txtEstado\".*?>).*?(?=</span>)')
            APELLIDO=$(extract '(?<=txtApellidos\" value=\").*?(?=\")')
            NOMBRE=$(extract '(?<=txtNombres\" value=\").*?(?=\")')
            CODIGO=$(extract '(?<=txtCodigoCredencial\" value=\").*?(?=\")')
            DNI=$(extract '(?<=txtRefExterna\" value=\").*?(?=\")')
            ESTADO_CIVIL=$(extract '(?<=cboEstadoCivil_I\" type=\"text\" value=\").*?(?=\")')
            EDAD=$(extract '(?<=txtEdad\" value=\").*?(?=\")')
            FECHA_NAC=$(extract '(?<=txtFecNacimiento_I\" type=\"text\" value=\").*?(?=\")')
            DISCAPACIDAD=$(extract '(?<=cboDiscapacitado_I\" type=\"text\" value=\").*?(?=\")')
            FUERZA=$(extract '(?<=afiFA\">).*?(?=</span>)')
            VIGENCIA=$(extract '(?<=txtFecha_Vigencia_I\" type=\"text\" value=\").*?(?=\")')
            ALTA_ADMIN=$(extract '(?<=txtFecha_Alta_Administrativa_I\" type=\"text\" value=\").*?(?=\")')
            PROVINCIA=$(extract '(?<=cboProvincia_I\" type=\"text\" value=\").*?(?=\")')
            LOCALIDAD=$(extract '(?<=cboLocalidad_I\" type=\"text\" value=\").*?(?=\")')
            CALLE=$(extract '(?<=txtCalle\" value=\").*?(?=\")')
            NUMERO=$(extract '(?<=txtNumero_I\" value=\").*?(?=\")')

            LINE="TIPO = $TIPO | ESTADO = $ESTADO | APELLIDO = $APELLIDO | NOMBRE = $NOMBRE | CODIGO = $CODIGO | DNI = $DNI | ESTADO CIVIL = $ESTADO_CIVIL | EDAD = $EDAD | FECHA DE NACIMIENTO = $FECHA_NAC | DISCAPACIDAD = $DISCAPACIDAD | FUERZAS DE ORIGEN = $FUERZA | VIGENCIA = $VIGENCIA | ALTA ADMINISTRATIVA = $ALTA_ADMIN | PROVIDENCIA = $PROVINCIA | LOCALIDAD = $LOCALIDAD | CALLE = $CALLE | NUMERO = $NUMERO"
            
            echo "$LINE" >> $OUTPUT
          done

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_name }}
          release_name: ${{ github.event.inputs.release_name }}
          body: "Resultados del scraping de IOSFA"
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload resultado.txt
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: resultado.txt
          asset_name: resultado.txt
          asset_content_type: text/plain
